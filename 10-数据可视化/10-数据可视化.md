# 第10章：数据可视化

数据可视化是数据分析的重要环节。Pandas内置了基于Matplotlib的绘图功能，使得数据可视化变得简单快捷。本章将详细介绍如何使用Pandas进行数据可视化。

## 10.1 基础绘图

### 10.1.1 线图（Line Plot）

```python
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

# 设置中文字体（可选）
plt.rcParams['font.sans-serif'] = ['SimHei']  # 用来正常显示中文标签
plt.rcParams['axes.unicode_minus'] = False  # 用来正常显示负号

# 创建简单的时间序列
dates = pd.date_range('2024-01-01', periods=30, freq='D')
ts = pd.Series(np.random.randn(30).cumsum(), index=dates)

# 基本线图
ts.plot()
plt.title('Simple Line Plot')
plt.xlabel('Date')
plt.ylabel('Value')
plt.grid(True)
plt.tight_layout()
# plt.savefig('line_plot.png')
print("基本线图已创建")

# 自定义样式
plt.figure(figsize=(10, 6))
ts.plot(style='--', color='red', linewidth=2, marker='o',
        markersize=5, alpha=0.7)
plt.title('Customized Line Plot')
plt.grid(True, linestyle=':', alpha=0.6)
plt.tight_layout()
print("自定义样式线图已创建")

# 多条线
df = pd.DataFrame({
    'A': np.random.randn(30).cumsum(),
    'B': np.random.randn(30).cumsum(),
    'C': np.random.randn(30).cumsum()
}, index=dates)

df.plot(figsize=(10, 6))
plt.title('Multiple Lines')
plt.xlabel('Date')
plt.ylabel('Value')
plt.legend(loc='best')
plt.grid(True)
plt.tight_layout()
print("多条线图已创建")
```

### 10.1.2 柱状图（Bar Plot）

```python
# 创建数据
data = pd.Series([25, 30, 35, 20, 40],
                index=['A', 'B', 'C', 'D', 'E'])

# 垂直柱状图
data.plot(kind='bar', figsize=(8, 6))
plt.title('Vertical Bar Chart')
plt.xlabel('Category')
plt.ylabel('Value')
plt.xticks(rotation=0)
plt.grid(axis='y', alpha=0.3)
plt.tight_layout()
print("垂直柱状图已创建")

# 水平柱状图
data.plot(kind='barh', figsize=(8, 6), color='coral')
plt.title('Horizontal Bar Chart')
plt.xlabel('Value')
plt.ylabel('Category')
plt.grid(axis='x', alpha=0.3)
plt.tight_layout()
print("水平柱状图已创建")

# DataFrame的柱状图
df = pd.DataFrame({
    'Category A': [10, 20, 30, 40],
    'Category B': [15, 25, 35, 45],
    'Category C': [12, 22, 32, 42]
}, index=['Q1', 'Q2', 'Q3', 'Q4'])

# 分组柱状图
df.plot(kind='bar', figsize=(10, 6))
plt.title('Grouped Bar Chart')
plt.xlabel('Quarter')
plt.ylabel('Value')
plt.legend(title='Categories')
plt.xticks(rotation=0)
plt.grid(axis='y', alpha=0.3)
plt.tight_layout()
print("分组柱状图已创建")

# 堆叠柱状图
df.plot(kind='bar', stacked=True, figsize=(10, 6))
plt.title('Stacked Bar Chart')
plt.xlabel('Quarter')
plt.ylabel('Value')
plt.legend(title='Categories')
plt.xticks(rotation=0)
plt.grid(axis='y', alpha=0.3)
plt.tight_layout()
print("堆叠柱状图已创建")
```

### 10.1.3 直方图（Histogram）

```python
# 创建随机数据
data = pd.Series(np.random.randn(1000))

# 基本直方图
data.plot(kind='hist', bins=30, figsize=(10, 6), alpha=0.7)
plt.title('Histogram')
plt.xlabel('Value')
plt.ylabel('Frequency')
plt.grid(axis='y', alpha=0.3)
plt.tight_layout()
print("直方图已创建")

# 多个直方图
df = pd.DataFrame({
    'A': np.random.randn(1000),
    'B': np.random.randn(1000) + 1,
    'C': np.random.randn(1000) - 1
})

df.plot(kind='hist', bins=30, alpha=0.5, figsize=(10, 6))
plt.title('Multiple Histograms')
plt.xlabel('Value')
plt.ylabel('Frequency')
plt.legend()
plt.grid(axis='y', alpha=0.3)
plt.tight_layout()
print("多个直方图已创建")

# 子图直方图
df.plot(kind='hist', bins=30, subplots=True, layout=(1, 3),
        figsize=(15, 4), alpha=0.7)
plt.tight_layout()
print("子图直方图已创建")
```

### 10.1.4 箱线图（Box Plot）

```python
# 创建数据
df = pd.DataFrame({
    'A': np.random.randn(100),
    'B': np.random.randn(100) * 2 + 1,
    'C': np.random.randn(100) * 0.5 - 1,
    'D': np.random.randn(100) * 1.5
})

# 箱线图
df.plot(kind='box', figsize=(10, 6))
plt.title('Box Plot')
plt.ylabel('Value')
plt.grid(axis='y', alpha=0.3)
plt.tight_layout()
print("箱线图已创建")

# 水平箱线图
df.plot(kind='box', vert=False, figsize=(10, 6))
plt.title('Horizontal Box Plot')
plt.xlabel('Value')
plt.grid(axis='x', alpha=0.3)
plt.tight_layout()
print("水平箱线图已创建")
```

### 10.1.5 散点图（Scatter Plot）

```python
# 创建数据
df = pd.DataFrame({
    'X': np.random.randn(100),
    'Y': np.random.randn(100),
    'Z': np.random.rand(100) * 100  # 用于大小
})

# 基本散点图
df.plot(kind='scatter', x='X', y='Y', figsize=(8, 6))
plt.title('Scatter Plot')
plt.grid(True, alpha=0.3)
plt.tight_layout()
print("基本散点图已创建")

# 带大小和颜色的散点图
df.plot(kind='scatter', x='X', y='Y', s=df['Z'],
        c='Z', colormap='viridis', figsize=(8, 6))
plt.title('Scatter Plot with Size and Color')
plt.colorbar(label='Z Value')
plt.grid(True, alpha=0.3)
plt.tight_layout()
print("彩色散点图已创建")

# 散点矩阵
df_multi = pd.DataFrame(np.random.randn(100, 4),
                       columns=['A', 'B', 'C', 'D'])
pd.plotting.scatter_matrix(df_multi, figsize=(12, 12), alpha=0.5,
                          diagonal='hist')
plt.tight_layout()
print("散点矩阵已创建")
```

### 10.1.6 饼图（Pie Chart）

```python
# 创建数据
data = pd.Series([30, 25, 20, 15, 10],
                index=['A', 'B', 'C', 'D', 'E'])

# 基本饼图
data.plot(kind='pie', figsize=(8, 8), autopct='%1.1f%%')
plt.title('Pie Chart')
plt.ylabel('')  # 移除y轴标签
plt.tight_layout()
print("饼图已创建")

# 自定义饼图
colors = ['#ff9999', '#66b3ff', '#99ff99', '#ffcc99', '#ff99cc']
explode = (0.1, 0, 0, 0, 0)  # 突出第一块

data.plot(kind='pie', figsize=(8, 8), autopct='%1.1f%%',
         colors=colors, explode=explode, shadow=True,
         startangle=90)
plt.title('Customized Pie Chart')
plt.ylabel('')
plt.tight_layout()
print("自定义饼图已创建")
```

## 10.2 高级绘图

### 10.2.1 面积图（Area Plot）

```python
# 创建数据
dates = pd.date_range('2024-01-01', periods=30, freq='D')
df = pd.DataFrame({
    'A': np.random.randn(30).cumsum(),
    'B': np.random.randn(30).cumsum(),
    'C': np.random.randn(30).cumsum()
}, index=dates)

# 面积图
df.plot(kind='area', figsize=(10, 6), alpha=0.4)
plt.title('Area Plot')
plt.xlabel('Date')
plt.ylabel('Value')
plt.legend(loc='upper left')
plt.grid(True, alpha=0.3)
plt.tight_layout()
print("面积图已创建")

# 堆叠面积图
df.abs().plot(kind='area', stacked=True, figsize=(10, 6), alpha=0.7)
plt.title('Stacked Area Plot')
plt.xlabel('Date')
plt.ylabel('Value')
plt.legend(loc='upper left')
plt.grid(True, alpha=0.3)
plt.tight_layout()
print("堆叠面积图已创建")
```

### 10.2.2 密度图（Density Plot/KDE）

```python
# 创建数据
df = pd.DataFrame({
    'A': np.random.randn(1000),
    'B': np.random.randn(1000) + 1,
    'C': np.random.randn(1000) - 1
})

# 密度图
df.plot(kind='density', figsize=(10, 6), linewidth=2)
plt.title('Density Plot')
plt.xlabel('Value')
plt.ylabel('Density')
plt.legend()
plt.grid(True, alpha=0.3)
plt.tight_layout()
print("密度图已创建")

# 子图密度图
df.plot(kind='density', subplots=True, layout=(1, 3),
        figsize=(15, 4), linewidth=2)
plt.tight_layout()
print("子图密度图已创建")
```

### 10.2.3 六角箱图（Hexbin Plot）

```python
# 创建数据
df = pd.DataFrame({
    'X': np.random.randn(10000),
    'Y': np.random.randn(10000)
})

# 六角箱图
df.plot(kind='hexbin', x='X', y='Y', gridsize=20,
        figsize=(10, 8), cmap='YlOrRd')
plt.title('Hexbin Plot')
plt.colorbar(label='Count')
plt.tight_layout()
print("六角箱图已创建")
```

### 10.2.4 lag图

```python
# 创建时间序列数据
np.random.seed(42)
ts = pd.Series(np.random.randn(1000).cumsum())

# Lag plot
pd.plotting.lag_plot(ts, lag=1)
plt.title('Lag Plot (lag=1)')
plt.tight_layout()
print("Lag图已创建")
```

### 10.2.5 自相关图

```python
# 自相关图
pd.plotting.autocorrelation_plot(ts)
plt.title('Autocorrelation Plot')
plt.tight_layout()
print("自相关图已创建")
```

## 10.3 子图布局

### 10.3.1 使用subplots参数

```python
# 创建数据
dates = pd.date_range('2024-01-01', periods=100, freq='D')
df = pd.DataFrame({
    'A': np.random.randn(100).cumsum(),
    'B': np.random.randn(100).cumsum(),
    'C': np.random.randn(100).cumsum(),
    'D': np.random.randn(100).cumsum()
}, index=dates)

# 垂直排列
df.plot(subplots=True, layout=(4, 1), figsize=(12, 10))
plt.tight_layout()
print("垂直子图已创建")

# 网格排列
df.plot(subplots=True, layout=(2, 2), figsize=(12, 8))
plt.tight_layout()
print("网格子图已创建")

# 共享x轴
df.plot(subplots=True, layout=(2, 2), figsize=(12, 8),
        sharex=True, sharey=False)
plt.tight_layout()
print("共享x轴子图已创建")
```

### 10.3.2 使用Matplotlib的subplot

```python
# 创建数据
data = pd.DataFrame({
    'Value': np.random.randn(100).cumsum()
})

# 创建多个子图
fig, axes = plt.subplots(2, 2, figsize=(12, 8))

# 不同类型的图
data.plot(ax=axes[0, 0], title='Line Plot')
data.plot(kind='hist', bins=20, ax=axes[0, 1], title='Histogram')
data.plot(kind='box', ax=axes[1, 0], title='Box Plot')
data.plot(kind='density', ax=axes[1, 1], title='Density Plot')

plt.tight_layout()
print("组合子图已创建")
```

## 10.4 样式和格式化

### 10.4.1 使用样式

```python
# 查看可用样式
print("可用样式:")
print(plt.style.available)

# 使用不同样式
dates = pd.date_range('2024-01-01', periods=50, freq='D')
ts = pd.Series(np.random.randn(50).cumsum(), index=dates)

# 使用ggplot样式
plt.style.use('ggplot')
ts.plot(figsize=(10, 6))
plt.title('ggplot Style')
plt.grid(True)
plt.tight_layout()
print("ggplot样式图已创建")

# 使用seaborn样式
plt.style.use('seaborn-v0_8')
ts.plot(figsize=(10, 6))
plt.title('Seaborn Style')
plt.grid(True)
plt.tight_layout()
print("seaborn样式图已创建")

# 恢复默认样式
plt.style.use('default')
```

### 10.4.2 颜色和标记

```python
# 创建数据
dates = pd.date_range('2024-01-01', periods=30, freq='D')
df = pd.DataFrame({
    'A': np.random.randn(30).cumsum(),
    'B': np.random.randn(30).cumsum(),
    'C': np.random.randn(30).cumsum()
}, index=dates)

# 自定义颜色
colors = ['#FF6B6B', '#4ECDC4', '#45B7D1']
df.plot(color=colors, figsize=(10, 6), linewidth=2)
plt.title('Custom Colors')
plt.grid(True, alpha=0.3)
plt.tight_layout()
print("自定义颜色图已创建")

# 自定义标记和线型
styles = ['r-', 'g--', 'b-.']
df.plot(style=styles, figsize=(10, 6), linewidth=2)
plt.title('Custom Styles')
plt.grid(True, alpha=0.3)
plt.tight_layout()
print("自定义样式图已创建")
```

### 10.4.3 图例和注释

```python
# 创建数据
dates = pd.date_range('2024-01-01', periods=30, freq='D')
ts = pd.Series(np.random.randn(30).cumsum(), index=dates)

# 添加注释
fig, ax = plt.subplots(figsize=(10, 6))
ts.plot(ax=ax, linewidth=2)

# 标注最高点和最低点
max_idx = ts.idxmax()
min_idx = ts.idxmin()
ax.annotate(f'Max: {ts[max_idx]:.2f}',
           xy=(max_idx, ts[max_idx]),
           xytext=(10, 10), textcoords='offset points',
           bbox=dict(boxstyle='round', facecolor='green', alpha=0.5),
           arrowprops=dict(arrowstyle='->', connectionstyle='arc3,rad=0'))

ax.annotate(f'Min: {ts[min_idx]:.2f}',
           xy=(min_idx, ts[min_idx]),
           xytext=(10, -20), textcoords='offset points',
           bbox=dict(boxstyle='round', facecolor='red', alpha=0.5),
           arrowprops=dict(arrowstyle='->', connectionstyle='arc3,rad=0'))

plt.title('Plot with Annotations')
plt.grid(True, alpha=0.3)
plt.tight_layout()
print("带注释的图已创建")
```

## 10.5 综合案例：销售数据可视化

```python
# 创建模拟的销售数据
np.random.seed(42)
dates = pd.date_range('2024-01-01', periods=365, freq='D')
products = ['Product A', 'Product B', 'Product C']
regions = ['North', 'South', 'East', 'West']

sales_data = []
for date in dates:
    for product in products:
        for region in regions:
            sales_data.append({
                'Date': date,
                'Product': product,
                'Region': region,
                'Sales': np.random.randint(100, 1000),
                'Quantity': np.random.randint(10, 100)
            })

df = pd.DataFrame(sales_data)
print("销售数据样例（前10行）:")
print(df.head(10))

# 1. 总销售额趋势
daily_sales = df.groupby('Date')['Sales'].sum()
plt.figure(figsize=(12, 6))
daily_sales.plot(linewidth=2)
daily_sales.rolling(window=30).mean().plot(linewidth=2, style='--')
plt.title('Daily Sales Trend')
plt.xlabel('Date')
plt.ylabel('Sales')
plt.legend(['Daily Sales', '30-day MA'])
plt.grid(True, alpha=0.3)
plt.tight_layout()
print("\n1. 销售额趋势图已创建")

# 2. 产品销售对比
product_sales = df.groupby('Product')['Sales'].sum()
plt.figure(figsize=(10, 6))
product_sales.plot(kind='bar', color=['#FF6B6B', '#4ECDC4', '#45B7D1'])
plt.title('Sales by Product')
plt.xlabel('Product')
plt.ylabel('Total Sales')
plt.xticks(rotation=0)
plt.grid(axis='y', alpha=0.3)
plt.tight_layout()
print("2. 产品销售对比图已创建")

# 3. 地区销售对比
region_sales = df.groupby('Region')['Sales'].sum()
plt.figure(figsize=(8, 8))
region_sales.plot(kind='pie', autopct='%1.1f%%',
                  colors=['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A'])
plt.title('Sales Distribution by Region')
plt.ylabel('')
plt.tight_layout()
print("3. 地区销售分布图已创建")

# 4. 月度销售热图
monthly_product = df.groupby([df['Date'].dt.to_period('M'), 'Product'])['Sales'].sum().unstack()
plt.figure(figsize=(12, 6))
import matplotlib.dates as mdates
monthly_product.plot(kind='bar', stacked=True, figsize=(12, 6))
plt.title('Monthly Sales by Product')
plt.xlabel('Month')
plt.ylabel('Sales')
plt.legend(title='Product', loc='upper left')
plt.xticks(rotation=45)
plt.grid(axis='y', alpha=0.3)
plt.tight_layout()
print("4. 月度销售堆叠图已创建")

# 5. 箱线图分析
plt.figure(figsize=(12, 6))
df.boxplot(column='Sales', by='Product', figsize=(10, 6))
plt.title('Sales Distribution by Product')
plt.suptitle('')  # 移除默认标题
plt.xlabel('Product')
plt.ylabel('Sales')
plt.tight_layout()
print("5. 产品销售分布箱线图已创建")

# 6. 散点图分析销售额与数量的关系
plt.figure(figsize=(10, 6))
for product in products:
    product_data = df[df['Product'] == product]
    plt.scatter(product_data['Quantity'], product_data['Sales'],
               label=product, alpha=0.5, s=50)
plt.title('Sales vs Quantity by Product')
plt.xlabel('Quantity')
plt.ylabel('Sales')
plt.legend()
plt.grid(True, alpha=0.3)
plt.tight_layout()
print("6. 销售额与数量关系图已创建")

# 7. 综合仪表板
fig, axes = plt.subplots(2, 2, figsize=(15, 10))

# 子图1：每日销售趋势
daily_sales.plot(ax=axes[0, 0], title='Daily Sales Trend')
axes[0, 0].grid(True, alpha=0.3)

# 子图2：产品销售柱状图
product_sales.plot(kind='bar', ax=axes[0, 1], title='Sales by Product')
axes[0, 1].grid(axis='y', alpha=0.3)

# 子图3：地区销售饼图
region_sales.plot(kind='pie', ax=axes[1, 0], title='Sales by Region',
                  autopct='%1.1f%%')
axes[1, 0].set_ylabel('')

# 子图4：月度趋势
monthly_sales = df.groupby(df['Date'].dt.to_period('M'))['Sales'].sum()
monthly_sales_numeric = df.groupby(df['Date'].dt.month)['Sales'].sum()
monthly_sales_numeric.plot(kind='line', ax=axes[1, 1],
                          title='Monthly Sales Pattern', marker='o')
axes[1, 1].set_xlabel('Month')
axes[1, 1].set_xticks(range(1, 13))
axes[1, 1].grid(True, alpha=0.3)

plt.tight_layout()
print("7. 综合仪表板已创建")

print("\n所有可视化图表创建完成！")
```

## 10.6 交互式绘图（简介）

```python
# Pandas也支持其他绘图后端
# 例如：plotly, bokeh等

# 使用plotly后端（需要安装：pip install plotly）
# pd.options.plotting.backend = 'plotly'

# 使用matplotlib后端（默认）
pd.options.plotting.backend = 'matplotlib'
```

## 10.7 保存图表

```python
# 创建一个简单的图表
dates = pd.date_range('2024-01-01', periods=30, freq='D')
ts = pd.Series(np.random.randn(30).cumsum(), index=dates)

fig, ax = plt.subplots(figsize=(10, 6))
ts.plot(ax=ax)
plt.title('Sample Plot')
plt.grid(True)

# 保存为不同格式
# plt.savefig('plot.png', dpi=300, bbox_inches='tight')
# plt.savefig('plot.pdf', bbox_inches='tight')
# plt.savefig('plot.svg', bbox_inches='tight')

print("图表可以保存为PNG、PDF、SVG等格式")
```

## 10.8 练习题

1. **基础练习**：创建一个数据集，绘制线图、柱状图、散点图。

2. **时间序列可视化**：创建一年的日销售数据，绘制趋势图并添加移动平均线。

3. **多图布局**：创建一个2x2的子图布局，展示同一数据的不同视角。

4. **样式定制**：创建一个图表并完全自定义其颜色、标记、标题、图例等。

5. **综合案例**：为一个完整的数据集创建一个仪表板，包含多种类型的图表。

## 10.9 小结

本章介绍了Pandas中的数据可视化功能：

- **基础图表**：线图、柱状图、直方图、箱线图、散点图、饼图
- **高级图表**：面积图、密度图、六角箱图、lag图、自相关图
- **子图布局**：使用subplots参数和Matplotlib subplot
- **样式定制**：颜色、标记、图例、注释
- **综合应用**：创建复杂的可视化仪表板

掌握这些技术可以快速创建各种数据可视化图表。

## 下一章

在下一章中，我们将学习**文件读写**，包括CSV、Excel、JSON、SQL等多种格式的数据读写。
