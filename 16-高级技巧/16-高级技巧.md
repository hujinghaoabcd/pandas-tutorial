# 第16章：高级技巧

本章介绍Pandas中的高级技巧，包括方法链、管道操作、样式设置等，帮助你写出更优雅高效的代码。

## 16.1 方法链（Method Chaining）

```python
import pandas as pd
import numpy as np

# 创建数据
df = pd.DataFrame({
    'Name': ['Alice', 'Bob', 'Charlie', 'David', 'Eve'],
    'Age': [25, 30, 35, 28, 32],
    'City': ['Beijing', 'Shanghai', 'Beijing', 'Guangzhou', 'Shanghai'],
    'Salary': [5000, 6000, 5500, 4500, 7000]
})

# 传统写法
df_temp = df[df['Age'] > 26]
df_temp = df_temp.groupby('City')['Salary'].mean()
df_result = df_temp.sort_values(ascending=False)
print("传统写法结果：")
print(df_result)

# 方法链写法
df_result = (df
             .query('Age > 26')
             .groupby('City')['Salary']
             .mean()
             .sort_values(ascending=False))
print("\n方法链写法结果：")
print(df_result)
```

## 16.2 管道操作（Pipe）

```python
# 自定义函数
def remove_outliers(df, column, n_std=2):
    """删除异常值"""
    mean = df[column].mean()
    std = df[column].std()
    return df[(df[column] >= mean - n_std*std) & (df[column] <= mean + n_std*std)]

def add_group_stats(df, group_col, value_col):
    """添加组统计"""
    df[f'{value_col}_GroupMean'] = df.groupby(group_col)[value_col].transform('mean')
    return df

# 使用pipe
df = pd.DataFrame({
    'Category': ['A', 'A', 'B', 'B', 'C', 'C'],
    'Value': [10, 100, 20, 30, 15, 25]  # 100是异常值
})

result = (df
          .pipe(remove_outliers, 'Value')
          .pipe(add_group_stats, 'Category', 'Value'))

print("管道操作结果：")
print(result)
```

## 16.3 样式设置

```python
# 创建数据
df = pd.DataFrame({
    'Product': ['A', 'B', 'C', 'D'],
    'Sales': [1200, 800, 1500, 600],
    'Growth': [0.15, -0.05, 0.25, -0.10]
})

# 设置样式
styled = (df.style
          .highlight_max(subset=['Sales'], color='lightgreen')
          .highlight_min(subset=['Sales'], color='lightcoral')
          .format({'Growth': '{:.1%}'}))

print("应用样式后的DataFrame:")
print(df)  # 实际应用中会显示彩色效果
```

## 16.4 query()方法

```python
# 创建数据
df = pd.DataFrame({
    'Name': ['Alice', 'Bob', 'Charlie', 'David', 'Eve'],
    'Age': [25, 30, 35, 28, 32],
    'Score': [85, 92, 78, 88, 95]
})

# 使用query
result1 = df.query('Age > 28 and Score > 85')
print("query结果：")
print(result1)

# 使用变量
min_age = 28
result2 = df.query('Age > @min_age')
print("\n使用变量的query：")
print(result2)
```

## 16.5 eval()方法

```python
# 创建数据
df = pd.DataFrame({
    'A': [1, 2, 3, 4, 5],
    'B': [10, 20, 30, 40, 50],
    'C': [100, 200, 300, 400, 500]
})

# 使用eval进行列运算
df.eval('D = A + B', inplace=True)
df.eval('E = A * B + C', inplace=True)

print("eval结果：")
print(df)
```

## 16.6 apply()高级用法

```python
# 创建数据
df = pd.DataFrame({
    'A': [1, 2, 3],
    'B': [4, 5, 6]
})

# 返回Series
result1 = df.apply(lambda x: x.max() - x.min())
print("返回Series：")
print(result1)

# 返回DataFrame
result2 = df.apply(lambda x: pd.Series({
    'sum': x.sum(),
    'mean': x.mean(),
    'std': x.std()
}))
print("\n返回DataFrame：")
print(result2)
```

## 16.7 窗口函数进阶

```python
# 创建数据
df = pd.DataFrame({
    'Date': pd.date_range('2024-01-01', periods=10),
    'Value': [10, 15, 13, 18, 20, 17, 22, 25, 23, 28]
})

# 自定义窗口函数
def custom_window_func(window):
    if len(window) < 3:
        return np.nan
    return (window.iloc[-1] - window.iloc[0]) / len(window)

df['Custom'] = df['Value'].rolling(window=3).apply(custom_window_func)
print("自定义窗口函数：")
print(df)
```

## 16.8 内存优化技巧

```python
# 创建大数据集
n = 100000
df_large = pd.DataFrame({
    'Category': np.random.choice(['A', 'B', 'C'], n),
    'Value': np.random.randn(n)
})

print("优化前内存使用：")
print(f"{df_large.memory_usage(deep=True).sum() / 1024**2:.2f} MB")

# 优化：转换为category类型
df_large['Category'] = df_large['Category'].astype('category')

print("\n优化后内存使用：")
print(f"{df_large.memory_usage(deep=True).sum() / 1024**2:.2f} MB")
```
