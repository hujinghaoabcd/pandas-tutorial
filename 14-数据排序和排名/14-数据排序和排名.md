# 第14章：数据排序和排名

排序和排名是数据分析中的基本操作。本章将介绍Pandas中各种排序和排名的方法及应用场景。

## 14.1 基础排序

```python
import pandas as pd
import numpy as np

# 创建示例数据
df = pd.DataFrame({
    'Name': ['Alice', 'Bob', 'Charlie', 'David', 'Eve'],
    'Age': [25, 30, 35, 25, 28],
    'Score': [85, 92, 78, 85, 95],
    'City': ['Beijing', 'Shanghai', 'Beijing', 'Guangzhou', 'Shanghai']
})

print("原始数据：")
print(df)

# 按单列排序
print("\n按年龄排序（升序）：")
print(df.sort_values('Age'))

# 降序排序
print("\n按分数排序（降序）：")
print(df.sort_values('Score', ascending=False))

# 按多列排序
print("\n按年龄和分数排序：")
print(df.sort_values(['Age', 'Score'], ascending=[True, False]))

# 按索引排序
print("\n按索引排序：")
df_indexed = df.set_index('Name')
print(df_indexed.sort_index())
```

## 14.2 高级排序

```python
# 自定义排序键
df = pd.DataFrame({
    'Name': ['Alice', 'bob', 'Charlie', 'david'],
    'Score': [85, 92, 78, 95]
})

print("原始数据：")
print(df)

# 不区分大小写排序
print("\n不区分大小写排序：")
print(df.sort_values('Name', key=lambda x: x.str.lower()))

# 使用自定义函数排序
def custom_sort(series):
    return series.str.len()

print("\n按名字长度排序：")
print(df.sort_values('Name', key=custom_sort))
```

## 14.3 排名

```python
# 创建数据
df = pd.DataFrame({
    'Student': ['Alice', 'Bob', 'Charlie', 'David', 'Eve'],
    'Score': [85, 92, 85, 78, 92]
})

print("原始数据：")
print(df)

# 基本排名
df['Rank_Default'] = df['Score'].rank()
print("\n默认排名：")
print(df)

# 不同的排名方法
df['Rank_Min'] = df['Score'].rank(method='min')  # 并列取最小
df['Rank_Max'] = df['Score'].rank(method='max')  # 并列取最大
df['Rank_First'] = df['Score'].rank(method='first')  # 先出现的排前
df['Rank_Dense'] = df['Score'].rank(method='dense')  # 密集排名

print("\n不同排名方法：")
print(df)

# 降序排名
df['Rank_Desc'] = df['Score'].rank(ascending=False)
print("\n降序排名：")
print(df[['Student', 'Score', 'Rank_Desc']])

# 百分位排名
df['Rank_Pct'] = df['Score'].rank(pct=True)
print("\n百分位排名：")
print(df[['Student', 'Score', 'Rank_Pct']])
```

## 14.4 分组排序和排名

```python
# 创建数据
df = pd.DataFrame({
    'Class': ['A', 'A', 'A', 'B', 'B', 'B'],
    'Student': ['Alice', 'Bob', 'Charlie', 'David', 'Eve', 'Frank'],
    'Score': [85, 92, 78, 88, 95, 82]
})

print("原始数据：")
print(df)

# 组内排序
print("\n按班级分组，组内按分数排序：")
df_sorted = df.sort_values(['Class', 'Score'], ascending=[True, False])
print(df_sorted)

# 组内排名
df['Rank_in_Class'] = df.groupby('Class')['Score'].rank(ascending=False)
print("\n组内排名：")
print(df)

# 找出每组的前N名
print("\n每个班级前2名：")
top_students = df.sort_values(['Class', 'Score'], ascending=[True, False]).groupby('Class').head(2)
print(top_students)
```

## 14.5 实战案例

```python
# 股票排名示例
np.random.seed(42)
stocks = pd.DataFrame({
    'Stock': [f'Stock{i}' for i in range(1, 21)],
    'Return': np.random.randn(20) * 0.1,
    'Volume': np.random.randint(1000, 10000, 20),
    'PE_Ratio': np.random.uniform(5, 30, 20)
})

print("股票数据（前10条）：")
print(stocks.head(10))

# 多因子排名
stocks['Return_Rank'] = stocks['Return'].rank(ascending=False)
stocks['Volume_Rank'] = stocks['Volume'].rank(ascending=False)
stocks['PE_Rank'] = stocks['PE_Ratio'].rank()  # PE越低越好

# 综合得分
stocks['Composite_Score'] = (
    stocks['Return_Rank'] * 0.5 +
    stocks['Volume_Rank'] * 0.3 +
    stocks['PE_Rank'] * 0.2
)

stocks['Final_Rank'] = stocks['Composite_Score'].rank()

print("\n综合排名（前5）：")
print(stocks.nsmallest(5, 'Final_Rank')[['Stock', 'Return', 'Volume', 'PE_Ratio', 'Final_Rank']])
```
