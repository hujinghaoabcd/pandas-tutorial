# 第7章：数据分组和聚合

数据分组和聚合是数据分析中最重要的操作之一。Pandas的`groupby()`方法提供了强大的分组功能，类似于SQL中的GROUP BY操作。本章将详细介绍如何使用这些功能。

## 7.1 GroupBy基础

### 7.1.1 简单分组

```python
import pandas as pd
import numpy as np

# 创建示例数据
data = pd.DataFrame({
    'Category': ['A', 'B', 'A', 'B', 'A', 'B'],
    'Value': [10, 20, 30, 40, 50, 60],
    'Count': [1, 2, 3, 4, 5, 6]
})

print("原始数据：")
print(data)

# 按类别分组
grouped = data.groupby('Category')
print("\nGroupBy对象：", grouped)

# 查看分组结果
print("\n分组的组数：", grouped.ngroups)
print("分组的组名：", list(grouped.groups.keys()))

# 查看每组的索引
print("\n每组的索引：")
for name, group in grouped:
    print(f"\n组 {name}:")
    print(group)
```

### 7.1.2 多列分组

```python
# 创建多列数据
data = pd.DataFrame({
    'Category': ['A', 'B', 'A', 'B', 'A', 'B', 'A', 'B'],
    'SubCategory': ['X', 'X', 'Y', 'Y', 'X', 'X', 'Y', 'Y'],
    'Value': [10, 20, 30, 40, 50, 60, 70, 80]
})

print("原始数据：")
print(data)

# 按多列分组
grouped = data.groupby(['Category', 'SubCategory'])
print("\n多列分组结果：")
for name, group in grouped:
    print(f"\n组 {name}:")
    print(group)
```

### 7.1.3 按索引分组

```python
# 创建多层索引数据
data = pd.DataFrame({
    'Value': [10, 20, 30, 40, 50, 60]
}, index=pd.MultiIndex.from_tuples([
    ('A', 'X'), ('A', 'Y'), ('B', 'X'),
    ('B', 'Y'), ('A', 'X'), ('B', 'Y')
], names=['Category', 'SubCategory']))

print("多层索引数据：")
print(data)

# 按第一层索引分组
grouped = data.groupby(level=0)
print("\n按第一层索引分组：")
for name, group in grouped:
    print(f"\n组 {name}:")
    print(group)

# 按第二层索引分组
grouped = data.groupby(level=1)
print("\n按第二层索引分组：")
for name, group in grouped:
    print(f"\n组 {name}:")
    print(group)
```

## 7.2 聚合操作

### 7.2.1 常用聚合函数

```python
# 创建示例数据
data = pd.DataFrame({
    'Category': ['A', 'B', 'A', 'B', 'A', 'B', 'A', 'B'],
    'Value1': [10, 20, 30, 40, 50, 60, 70, 80],
    'Value2': [1, 2, 3, 4, 5, 6, 7, 8]
})

print("原始数据：")
print(data)

grouped = data.groupby('Category')

# 求和
print("\n求和：")
print(grouped.sum())

# 平均值
print("\n平均值：")
print(grouped.mean())

# 中位数
print("\n中位数：")
print(grouped.median())

# 最大值和最小值
print("\n最大值：")
print(grouped.max())

print("\n最小值：")
print(grouped.min())

# 标准差
print("\n标准差：")
print(grouped.std())

# 方差
print("\n方差：")
print(grouped.var())

# 计数
print("\n计数：")
print(grouped.count())

# 描述统计
print("\n描述统计：")
print(grouped.describe())
```

### 7.2.2 agg()方法：应用多个聚合函数

```python
# 创建示例数据
data = pd.DataFrame({
    'Category': ['A', 'B', 'A', 'B', 'A', 'B'],
    'Value': [10, 20, 30, 40, 50, 60]
})

grouped = data.groupby('Category')

# 对同一列应用多个聚合函数
print("对Value列应用多个函数：")
result = grouped['Value'].agg(['sum', 'mean', 'std', 'min', 'max'])
print(result)

# 对不同列应用不同函数
data_multi = pd.DataFrame({
    'Category': ['A', 'B', 'A', 'B', 'A', 'B'],
    'Value1': [10, 20, 30, 40, 50, 60],
    'Value2': [100, 200, 300, 400, 500, 600]
})

print("\n对不同列应用不同函数：")
result = data_multi.groupby('Category').agg({
    'Value1': ['sum', 'mean'],
    'Value2': ['min', 'max']
})
print(result)

# 使用自定义函数
print("\n使用自定义函数：")
result = grouped['Value'].agg([
    ('总和', 'sum'),
    ('平均值', 'mean'),
    ('范围', lambda x: x.max() - x.min())
])
print(result)
```

### 7.2.3 transform()方法：保持原数据形状

```python
# 创建示例数据
data = pd.DataFrame({
    'Category': ['A', 'B', 'A', 'B', 'A', 'B'],
    'Value': [10, 20, 30, 40, 50, 60]
})

print("原始数据：")
print(data)

# 计算每组的平均值并保持原数据形状
data['Group_Mean'] = data.groupby('Category')['Value'].transform('mean')
print("\n添加组平均值：")
print(data)

# 计算每个值与组平均值的差异
data['Diff_from_Mean'] = data['Value'] - data['Group_Mean']
print("\n添加与平均值的差异：")
print(data)

# 标准化（Z-score）
data['Normalized'] = data.groupby('Category')['Value'].transform(
    lambda x: (x - x.mean()) / x.std()
)
print("\n添加标准化值：")
print(data)
```

### 7.2.4 apply()方法：灵活的自定义操作

```python
# 创建示例数据
data = pd.DataFrame({
    'Category': ['A', 'B', 'A', 'B', 'A', 'B'],
    'Value': [10, 20, 30, 40, 50, 60]
})

# 对每组应用自定义函数
def custom_function(group):
    """计算组内的一些统计量"""
    return pd.Series({
        'sum': group['Value'].sum(),
        'mean': group['Value'].mean(),
        'range': group['Value'].max() - group['Value'].min(),
        'count': len(group)
    })

result = data.groupby('Category').apply(custom_function)
print("应用自定义函数：")
print(result)

# 返回DataFrame
def top_n(group, n=2):
    """返回每组前n个最大值"""
    return group.nlargest(n, 'Value')

print("\n每组前2个最大值：")
result = data.groupby('Category').apply(top_n, n=2)
print(result)
```

## 7.3 过滤和筛选

### 7.3.1 filter()方法

```python
# 创建示例数据
data = pd.DataFrame({
    'Category': ['A', 'B', 'A', 'B', 'A', 'C'],
    'Value': [10, 20, 30, 40, 50, 60]
})

print("原始数据：")
print(data)

# 过滤掉样本数少于3的组
result = data.groupby('Category').filter(lambda x: len(x) >= 3)
print("\n过滤后的数据（保留样本数>=3的组）：")
print(result)

# 过滤掉平均值小于30的组
result = data.groupby('Category').filter(lambda x: x['Value'].mean() >= 30)
print("\n过滤后的数据（保留平均值>=30的组）：")
print(result)
```

### 7.3.2 head()和tail()

```python
# 创建示例数据
data = pd.DataFrame({
    'Category': ['A', 'B', 'A', 'B', 'A', 'B', 'A', 'B'],
    'Value': [10, 20, 30, 40, 50, 60, 70, 80]
})

grouped = data.groupby('Category')

# 获取每组的前2个元素
print("每组的前2个元素：")
print(grouped.head(2))

# 获取每组的后2个元素
print("\n每组的后2个元素：")
print(grouped.tail(2))

# 获取每组的第n个元素
print("\n每组的第1个元素：")
print(grouped.nth(0))
```

## 7.4 高级分组操作

### 7.4.1 按自定义函数分组

```python
# 创建示例数据
data = pd.DataFrame({
    'Name': ['Alice', 'Bob', 'Charlie', 'David', 'Eve'],
    'Value': [10, 20, 30, 40, 50]
})

print("原始数据：")
print(data)

# 按名字长度分组
grouped = data.groupby(data['Name'].str.len())
print("\n按名字长度分组：")
for name, group in grouped:
    print(f"\n长度为 {name} 的名字:")
    print(group)

# 按值的范围分组
def value_range(value):
    if value < 25:
        return 'Low'
    elif value < 45:
        return 'Medium'
    else:
        return 'High'

grouped = data.groupby(data['Value'].apply(value_range))
print("\n按值的范围分组：")
for name, group in grouped:
    print(f"\n{name} 组:")
    print(group)
```

### 7.4.2 按时间分组

```python
# 创建时间序列数据
dates = pd.date_range('2024-01-01', periods=365, freq='D')
data = pd.DataFrame({
    'Date': dates,
    'Value': np.random.randint(1, 100, 365)
})
data.set_index('Date', inplace=True)

print("时间序列数据（前5行）：")
print(data.head())

# 按月分组
monthly = data.groupby(pd.Grouper(freq='M'))
print("\n按月聚合：")
print(monthly.sum().head())

# 按周分组
weekly = data.groupby(pd.Grouper(freq='W'))
print("\n按周聚合（前5周）：")
print(weekly.sum().head())

# 按季度分组
quarterly = data.groupby(pd.Grouper(freq='Q'))
print("\n按季度聚合：")
print(quarterly.sum())
```

### 7.4.3 分组后的累计操作

```python
# 创建示例数据
data = pd.DataFrame({
    'Category': ['A', 'A', 'A', 'B', 'B', 'B'],
    'Value': [10, 20, 30, 15, 25, 35]
})

print("原始数据：")
print(data)

# 组内累计和
data['Cumsum'] = data.groupby('Category')['Value'].cumsum()
print("\n添加累计和：")
print(data)

# 组内累计平均
data['Cummean'] = data.groupby('Category')['Value'].apply(
    lambda x: x.expanding().mean()
)
print("\n添加累计平均：")
print(data)

# 组内排名
data['Rank'] = data.groupby('Category')['Value'].rank()
print("\n添加组内排名：")
print(data)

# 组内百分比排名
data['Pct_Rank'] = data.groupby('Category')['Value'].rank(pct=True)
print("\n添加组内百分比排名：")
print(data)
```

## 7.5 数据透视和交叉表

### 7.5.1 pivot_table()：数据透视表

```python
# 创建示例数据
data = pd.DataFrame({
    'Date': ['2024-01-01', '2024-01-01', '2024-01-02', '2024-01-02',
             '2024-01-01', '2024-01-01', '2024-01-02', '2024-01-02'],
    'City': ['Beijing', 'Beijing', 'Beijing', 'Beijing',
             'Shanghai', 'Shanghai', 'Shanghai', 'Shanghai'],
    'Product': ['A', 'B', 'A', 'B', 'A', 'B', 'A', 'B'],
    'Sales': [100, 150, 120, 130, 90, 110, 100, 120],
    'Quantity': [10, 15, 12, 13, 9, 11, 10, 12]
})

print("原始数据：")
print(data)

# 简单的数据透视表
pivot = pd.pivot_table(data, values='Sales', index='City', columns='Product')
print("\n简单的数据透视表：")
print(pivot)

# 多个聚合值
pivot = pd.pivot_table(data, values=['Sales', 'Quantity'],
                       index='City', columns='Product')
print("\n多个聚合值：")
print(pivot)

# 多个聚合函数
pivot = pd.pivot_table(data, values='Sales',
                       index='City', columns='Product',
                       aggfunc=['sum', 'mean'])
print("\n多个聚合函数：")
print(pivot)

# 添加行和列的总计
pivot = pd.pivot_table(data, values='Sales',
                       index='City', columns='Product',
                       aggfunc='sum', margins=True, margins_name='Total')
print("\n添加总计：")
print(pivot)
```

### 7.5.2 crosstab()：交叉表

```python
# 创建分类数据
data = pd.DataFrame({
    'Gender': ['M', 'F', 'M', 'F', 'M', 'F', 'M', 'F'],
    'Age_Group': ['Young', 'Young', 'Old', 'Old', 'Young', 'Young', 'Old', 'Old'],
    'Product': ['A', 'A', 'A', 'A', 'B', 'B', 'B', 'B']
})

print("原始数据：")
print(data)

# 简单交叉表（频数统计）
cross = pd.crosstab(data['Gender'], data['Product'])
print("\n交叉表：")
print(cross)

# 多维交叉表
cross = pd.crosstab([data['Gender'], data['Age_Group']], data['Product'])
print("\n多维交叉表：")
print(cross)

# 添加行和列的总计
cross = pd.crosstab(data['Gender'], data['Product'], margins=True)
print("\n添加总计：")
print(cross)

# 标准化（计算比例）
cross = pd.crosstab(data['Gender'], data['Product'], normalize='index')
print("\n按行标准化：")
print(cross)

cross = pd.crosstab(data['Gender'], data['Product'], normalize='columns')
print("\n按列标准化：")
print(cross)

cross = pd.crosstab(data['Gender'], data['Product'], normalize='all')
print("\n全局标准化：")
print(cross)
```

## 7.6 窗口函数

### 7.6.1 滚动窗口

```python
# 创建时间序列数据
dates = pd.date_range('2024-01-01', periods=10, freq='D')
data = pd.DataFrame({
    'Date': dates,
    'Value': [10, 15, 13, 18, 20, 17, 22, 25, 23, 28]
})
data.set_index('Date', inplace=True)

print("原始数据：")
print(data)

# 3天移动平均
data['MA_3'] = data['Value'].rolling(window=3).mean()
print("\n3天移动平均：")
print(data)

# 3天移动和
data['Sum_3'] = data['Value'].rolling(window=3).sum()
print("\n3天移动和：")
print(data)

# 3天移动标准差
data['Std_3'] = data['Value'].rolling(window=3).std()
print("\n3天移动标准差：")
print(data)

# 自定义窗口函数
data['Custom'] = data['Value'].rolling(window=3).apply(lambda x: x.max() - x.min())
print("\n自定义窗口函数（最大值-最小值）：")
print(data)
```

### 7.6.2 扩展窗口

```python
# 创建数据
data = pd.DataFrame({
    'Value': [10, 15, 13, 18, 20, 17, 22, 25, 23, 28]
})

print("原始数据：")
print(data)

# 累计平均
data['Expanding_Mean'] = data['Value'].expanding().mean()
print("\n累计平均：")
print(data)

# 累计和
data['Expanding_Sum'] = data['Value'].expanding().sum()
print("\n累计和：")
print(data)

# 累计最大值
data['Expanding_Max'] = data['Value'].expanding().max()
print("\n累计最大值：")
print(data)
```

### 7.6.3 指数加权移动平均

```python
# 创建数据
data = pd.DataFrame({
    'Value': [10, 15, 13, 18, 20, 17, 22, 25, 23, 28]
})

print("原始数据：")
print(data)

# 指数加权移动平均（span=3）
data['EWM_3'] = data['Value'].ewm(span=3).mean()
print("\n指数加权移动平均（span=3）：")
print(data)

# 不同的参数
data['EWM_halflife'] = data['Value'].ewm(halflife=2).mean()
print("\n指数加权移动平均（halflife=2）：")
print(data)
```

## 7.7 综合案例：销售数据分析

```python
# 创建模拟的销售数据
np.random.seed(42)
dates = pd.date_range('2024-01-01', periods=100, freq='D')
data = pd.DataFrame({
    'Date': np.repeat(dates, 3),
    'Product': np.tile(['A', 'B', 'C'], 100),
    'Region': np.tile(['North', 'South', 'East'], 100),
    'Sales': np.random.randint(100, 1000, 300),
    'Quantity': np.random.randint(1, 20, 300)
})

print("销售数据（前10行）：")
print(data.head(10))

# 1. 按产品和地区分组统计
print("\n1. 按产品和地区分组统计：")
product_region_stats = data.groupby(['Product', 'Region']).agg({
    'Sales': ['sum', 'mean', 'std'],
    'Quantity': ['sum', 'mean']
}).round(2)
print(product_region_stats)

# 2. 按日期汇总（设置Date为索引）
data_with_date = data.set_index('Date')
print("\n2. 按月汇总销售额：")
monthly_sales = data_with_date.groupby([
    pd.Grouper(freq='M'),
    'Product'
])['Sales'].sum().unstack(fill_value=0)
print(monthly_sales)

# 3. 计算每个产品的销售趋势
print("\n3. 计算7天移动平均：")
data_sorted = data.sort_values('Date')
data_sorted['Sales_MA7'] = data_sorted.groupby('Product')['Sales'].transform(
    lambda x: x.rolling(window=7, min_periods=1).mean()
)
print(data_sorted[['Date', 'Product', 'Sales', 'Sales_MA7']].head(21))

# 4. 找出每个地区销售额最高的产品
print("\n4. 每个地区销售额最高的产品：")
top_products = data.groupby(['Region', 'Product'])['Sales'].sum().reset_index()
idx = top_products.groupby('Region')['Sales'].idxmax()
print(top_products.loc[idx])

# 5. 计算每个产品的销售占比
print("\n5. 各产品销售占比：")
product_sales = data.groupby('Product')['Sales'].sum()
product_pct = (product_sales / product_sales.sum() * 100).round(2)
print(product_pct)

# 6. 数据透视表：按地区和产品分析
print("\n6. 数据透视表：")
pivot = pd.pivot_table(data, values='Sales', index='Region',
                       columns='Product', aggfunc=['sum', 'mean'],
                       margins=True)
print(pivot)

# 7. 找出销售额异常的记录（3倍标准差）
print("\n7. 销售额异常记录：")
mean_sales = data['Sales'].mean()
std_sales = data['Sales'].std()
outliers = data[(data['Sales'] > mean_sales + 3*std_sales) |
                (data['Sales'] < mean_sales - 3*std_sales)]
print(f"异常记录数: {len(outliers)}")
if len(outliers) > 0:
    print(outliers)

# 8. 同比增长分析
print("\n8. 产品月度增长率：")
data_with_date = data.set_index('Date')
monthly_by_product = data_with_date.groupby([
    pd.Grouper(freq='M'),
    'Product'
])['Sales'].sum().unstack(fill_value=0)
growth_rate = monthly_by_product.pct_change() * 100
print(growth_rate.round(2).head())
```

## 7.8 性能优化

### 7.8.1 使用numba加速

```python
# 对于大数据集，可以使用numba加速自定义函数
# 需要先安装：pip install numba

# from numba import jit

# @jit
# def custom_sum(x):
#     total = 0
#     for i in range(len(x)):
#         total += x[i]
#     return total

# data.groupby('Category')['Value'].agg(custom_sum)
```

### 7.8.2 避免apply的性能问题

```python
# 创建大数据集
n = 100000
data = pd.DataFrame({
    'Category': np.random.choice(['A', 'B', 'C'], n),
    'Value': np.random.randn(n)
})

# 慢速方法：使用apply
import time
start = time.time()
result1 = data.groupby('Category')['Value'].apply(lambda x: x - x.mean())
time1 = time.time() - start

# 快速方法：使用transform
start = time.time()
result2 = data.groupby('Category')['Value'].transform(lambda x: x - x.mean())
time2 = time.time() - start

print(f"apply方法耗时: {time1:.4f}秒")
print(f"transform方法耗时: {time2:.4f}秒")
print(f"加速比: {time1/time2:.2f}x")
```

## 7.9 练习题

1. **基础练习**：创建一个包含学生信息和成绩的DataFrame，按班级分组并计算各种统计量。

2. **时间序列分组**：创建一年的日销售数据，按月、季度分组统计。

3. **数据透视表**：创建一个多维度的销售数据，使用pivot_table进行多角度分析。

4. **自定义聚合**：使用apply方法实现复杂的自定义聚合逻辑。

5. **综合案例**：分析一个包含多个维度的真实数据集，进行全面的分组聚合分析。

## 7.10 小结

本章介绍了Pandas中的数据分组和聚合技术：

- **GroupBy基础**：单列、多列、索引分组
- **聚合操作**：常用聚合函数、agg()、transform()、apply()
- **过滤筛选**：filter()、head()、tail()、nth()
- **高级操作**：自定义分组、时间分组、累计操作
- **数据透视**：pivot_table()、crosstab()
- **窗口函数**：rolling()、expanding()、ewm()
- **性能优化**：使用合适的方法提高性能

掌握这些技术可以高效地进行数据分析和统计。

## 下一章

在下一章中，我们将学习**数据重塑和透视**，包括stack、unstack、melt、pivot等操作。
