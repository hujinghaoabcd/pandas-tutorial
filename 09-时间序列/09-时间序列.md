# 第9章：时间序列

时间序列分析是数据分析中的重要内容。Pandas提供了强大的时间序列处理功能，包括日期时间解析、时间索引、重采样、时间窗口等。本章将详细介绍这些功能。

## 9.1 日期和时间基础

### 9.1.1 创建日期时间对象

```python
import pandas as pd
import numpy as np
from datetime import datetime, timedelta

# 使用pd.Timestamp创建时间戳
ts = pd.Timestamp('2024-01-01')
print("时间戳:", ts)
print("类型:", type(ts))

# 从不同格式的字符串创建
ts1 = pd.Timestamp('2024-01-01')
ts2 = pd.Timestamp('2024/01/01')
ts3 = pd.Timestamp('20240101')
ts4 = pd.Timestamp('Jan 01, 2024')
print("\n不同格式的时间戳:")
print(ts1, ts2, ts3, ts4)

# 从datetime对象创建
dt = datetime(2024, 1, 1, 12, 30, 45)
ts = pd.Timestamp(dt)
print("\n从datetime创建:", ts)

# 访问时间戳的属性
print("\n时间戳属性:")
print(f"年: {ts.year}")
print(f"月: {ts.month}")
print(f"日: {ts.day}")
print(f"小时: {ts.hour}")
print(f"分钟: {ts.minute}")
print(f"秒: {ts.second}")
print(f"星期几: {ts.dayofweek}")  # 0=Monday
print(f"星期几名称: {ts.day_name()}")
print(f"月份名称: {ts.month_name()}")
```

### 9.1.2 时间周期

```python
# 创建时间周期
period = pd.Period('2024-01', freq='M')
print("月度周期:", period)

# 不同频率的周期
period_day = pd.Period('2024-01-01', freq='D')
period_quarter = pd.Period('2024Q1', freq='Q')
period_year = pd.Period('2024', freq='Y')
print("\n不同频率的周期:")
print(f"日: {period_day}")
print(f"季度: {period_quarter}")
print(f"年: {period_year}")

# 周期运算
next_month = period + 1
print(f"\n下个月: {next_month}")
prev_month = period - 1
print(f"上个月: {prev_month}")
```

### 9.1.3 时间间隔

```python
# 创建时间间隔
delta = pd.Timedelta('1 day')
print("时间间隔:", delta)

# 不同的时间间隔
delta1 = pd.Timedelta('2 hours')
delta2 = pd.Timedelta('30 minutes')
delta3 = pd.Timedelta('1 day 2 hours 30 minutes')
print("\n不同的时间间隔:")
print(delta1, delta2, delta3)

# 时间间隔运算
ts = pd.Timestamp('2024-01-01')
future = ts + pd.Timedelta('5 days')
past = ts - pd.Timedelta('3 days')
print(f"\n5天后: {future}")
print(f"3天前: {past}")
```

## 9.2 日期时间索引

### 9.2.1 创建日期范围

```python
# 使用date_range创建日期范围
dates = pd.date_range('2024-01-01', periods=10, freq='D')
print("日期范围（10天）:")
print(dates)

# 指定开始和结束日期
dates = pd.date_range('2024-01-01', '2024-01-10', freq='D')
print("\n指定开始和结束日期:")
print(dates)

# 不同的频率
hourly = pd.date_range('2024-01-01', periods=24, freq='h')
print("\n小时频率（24小时）:")
print(hourly[:5])

weekly = pd.date_range('2024-01-01', periods=10, freq='W')
print("\n周频率（10周）:")
print(weekly)

monthly = pd.date_range('2024-01-01', periods=12, freq='M')
print("\n月频率（12个月）:")
print(monthly)

# 工作日
business_days = pd.date_range('2024-01-01', periods=10, freq='B')
print("\n工作日（10个）:")
print(business_days)
```

### 9.2.2 常用频率代码

```python
# 常用频率代码示例
freq_examples = {
    'D': '日历日',
    'B': '工作日',
    'W': '周',
    'M': '月末',
    'MS': '月初',
    'Q': '季度末',
    'QS': '季度初',
    'Y': '年末',
    'YS': '年初',
    'h': '小时',
    'T' or 'min': '分钟',
    'S': '秒',
    'L' or 'ms': '毫秒'
}

print("常用频率代码:")
for code, desc in freq_examples.items():
    print(f"{code}: {desc}")

# 组合频率
dates_2d = pd.date_range('2024-01-01', periods=5, freq='2D')
print("\n每2天:")
print(dates_2d)

dates_3h = pd.date_range('2024-01-01', periods=5, freq='3h')
print("\n每3小时:")
print(dates_3h)
```

### 9.2.3 创建时间序列

```python
# 创建时间序列
dates = pd.date_range('2024-01-01', periods=10, freq='D')
values = np.random.randn(10)
ts = pd.Series(values, index=dates)
print("时间序列:")
print(ts)

# 创建时间序列DataFrame
df = pd.DataFrame({
    'Value1': np.random.randn(10),
    'Value2': np.random.randn(10)
}, index=dates)
print("\n时间序列DataFrame:")
print(df)
```

## 9.3 时间序列索引和选择

### 9.3.1 基本索引

```python
# 创建时间序列
dates = pd.date_range('2024-01-01', periods=100, freq='D')
ts = pd.Series(np.random.randn(100), index=dates)

# 使用字符串索引
print("2024年1月1日的值:")
print(ts['2024-01-01'])

# 范围索引
print("\n2024年1月前5天:")
print(ts['2024-01-01':'2024-01-05'])

# 部分字符串索引
print("\n2024年1月的所有数据（前10个）:")
print(ts['2024-01'].head(10))

# 使用年份
print("\n2024年的统计信息:")
print(ts['2024'].describe())
```

### 9.3.2 时间序列切片

```python
# 创建更长的时间序列
dates = pd.date_range('2024-01-01', periods=365, freq='D')
ts = pd.Series(np.random.randn(365), index=dates)

# 选择特定月份
jan_data = ts['2024-01']
print(f"1月数据点数: {len(jan_data)}")

# 选择季度
q1_data = ts['2024-01':'2024-03']
print(f"\n第一季度数据点数: {len(q1_data)}")

# 使用truncate方法
truncated = ts.truncate(before='2024-06-01', after='2024-08-31')
print(f"\n6-8月数据点数: {len(truncated)}")
```

### 9.3.3 高级选择

```python
# 创建时间序列DataFrame
dates = pd.date_range('2024-01-01', periods=100, freq='h')
df = pd.DataFrame({
    'Value': np.random.randn(100)
}, index=dates)

# 选择特定时间段
morning = df.between_time('09:00', '12:00')
print("上午9点到12点的数据:")
print(morning.head())

# 选择特定日期
specific_dates = df.at_time('10:00')
print("\n每天10点的数据:")
print(specific_dates.head())
```

## 9.4 时间序列操作

### 9.4.1 移位操作

```python
# 创建时间序列
dates = pd.date_range('2024-01-01', periods=10, freq='D')
ts = pd.Series(range(10), index=dates)
print("原始时间序列:")
print(ts)

# 向前移位（数据向后）
ts_shift_forward = ts.shift(2)
print("\n向前移位2个位置:")
print(ts_shift_forward)

# 向后移位（数据向前）
ts_shift_backward = ts.shift(-2)
print("\n向后移位2个位置:")
print(ts_shift_backward)

# 按时间移位
ts_shift_time = ts.shift(2, freq='D')
print("\n按时间移位2天:")
print(ts_shift_time)
```

### 9.4.2 计算变化率

```python
# 创建价格时间序列
dates = pd.date_range('2024-01-01', periods=10, freq='D')
prices = pd.Series([100, 102, 105, 103, 107, 110, 108, 112, 115, 113],
                   index=dates)
print("价格时间序列:")
print(prices)

# 计算差分
diff = prices.diff()
print("\n一阶差分:")
print(diff)

# 计算百分比变化
pct_change = prices.pct_change()
print("\n百分比变化:")
print(pct_change)

# 计算与第一个值的百分比变化
pct_from_first = prices / prices.iloc[0] - 1
print("\n相对于初始值的变化:")
print(pct_from_first)
```

### 9.4.3 滚动窗口

```python
# 创建时间序列
dates = pd.date_range('2024-01-01', periods=20, freq='D')
values = np.random.randn(20).cumsum()
ts = pd.Series(values, index=dates)
print("原始时间序列:")
print(ts)

# 移动平均
ma_3 = ts.rolling(window=3).mean()
print("\n3日移动平均:")
print(ma_3)

# 移动标准差
std_3 = ts.rolling(window=3).std()
print("\n3日移动标准差:")
print(std_3.dropna())

# 移动最大值和最小值
rolling_max = ts.rolling(window=3).max()
rolling_min = ts.rolling(window=3).min()
print("\n3日移动最大值:")
print(rolling_max.dropna())

# 自定义滚动函数
rolling_range = ts.rolling(window=3).apply(lambda x: x.max() - x.min())
print("\n3日移动范围:")
print(rolling_range.dropna())
```

### 9.4.4 扩展窗口

```python
# 创建时间序列
dates = pd.date_range('2024-01-01', periods=10, freq='D')
ts = pd.Series(range(1, 11), index=dates)
print("原始时间序列:")
print(ts)

# 累计平均
expanding_mean = ts.expanding().mean()
print("\n累计平均:")
print(expanding_mean)

# 累计和
expanding_sum = ts.expanding().sum()
print("\n累计和:")
print(expanding_sum)

# 累计最大值
expanding_max = ts.expanding().max()
print("\n累计最大值:")
print(expanding_max)
```

### 9.4.5 指数加权移动平均

```python
# 创建时间序列
dates = pd.date_range('2024-01-01', periods=20, freq='D')
ts = pd.Series(np.random.randn(20), index=dates)
print("原始时间序列:")
print(ts)

# 指数加权移动平均
ewma = ts.ewm(span=5).mean()
print("\nEWMA (span=5):")
print(ewma)

# 不同的参数
ewma_halflife = ts.ewm(halflife=3).mean()
print("\nEWMA (halflife=3):")
print(ewma_halflife)

# 指数加权标准差
ewm_std = ts.ewm(span=5).std()
print("\nEWM标准差 (span=5):")
print(ewm_std)
```

## 9.5 重采样和频率转换

### 9.5.1 降采样（Downsampling）

```python
# 创建高频数据
dates = pd.date_range('2024-01-01', periods=100, freq='h')
ts = pd.Series(np.random.randn(100), index=dates)
print("原始小时数据（前10个）:")
print(ts.head(10))

# 降采样为日数据
daily = ts.resample('D').mean()
print("\n降采样为日数据（取平均）:")
print(daily.head())

# 使用不同的聚合函数
daily_sum = ts.resample('D').sum()
daily_max = ts.resample('D').max()
daily_min = ts.resample('D').min()
print("\n日数据（求和）:")
print(daily_sum.head())

# 多个聚合函数
daily_agg = ts.resample('D').agg(['mean', 'std', 'min', 'max'])
print("\n日数据（多个聚合）:")
print(daily_agg.head())
```

### 9.5.2 升采样（Upsampling）

```python
# 创建低频数据
dates = pd.date_range('2024-01-01', periods=10, freq='D')
ts = pd.Series(range(10), index=dates)
print("原始日数据:")
print(ts)

# 升采样为小时数据
hourly = ts.resample('h').ffill()  # 向前填充
print("\n升采样为小时数据（前25个）:")
print(hourly.head(25))

# 使用插值
hourly_interp = ts.resample('h').interpolate()
print("\n升采样为小时数据（插值）:")
print(hourly_interp.head(25))

# 使用asfreq
hourly_asfreq = ts.resample('h').asfreq()
print("\n升采样为小时数据（asfreq）:")
print(hourly_asfreq.head(25))
```

### 9.5.3 OHLC重采样

```python
# 创建模拟的价格数据
dates = pd.date_range('2024-01-01', periods=100, freq='h')
prices = pd.Series(100 + np.random.randn(100).cumsum(), index=dates)
print("原始小时价格数据（前10个）:")
print(prices.head(10))

# OHLC（开盘、最高、最低、收盘）
daily_ohlc = prices.resample('D').ohlc()
print("\n日OHLC数据:")
print(daily_ohlc)

# 添加成交量
volume = pd.Series(np.random.randint(1000, 5000, 100), index=dates)
df = pd.DataFrame({'price': prices, 'volume': volume})
daily_ohlc_v = df.resample('D').agg({
    'price': 'ohlc',
    'volume': 'sum'
})
print("\n带成交量的日OHLC数据:")
print(daily_ohlc_v)
```

## 9.6 时区处理

### 9.6.1 时区基础

```python
# 创建不带时区的时间序列
dates = pd.date_range('2024-01-01', periods=5, freq='D')
ts = pd.Series(range(5), index=dates)
print("不带时区的时间序列:")
print(ts)
print("时区:", ts.index.tz)

# 添加时区信息
ts_utc = ts.tz_localize('UTC')
print("\n添加UTC时区:")
print(ts_utc)
print("时区:", ts_utc.index.tz)

# 转换时区
ts_tokyo = ts_utc.tz_convert('Asia/Tokyo')
print("\n转换为东京时区:")
print(ts_tokyo)

ts_ny = ts_utc.tz_convert('America/New_York')
print("\n转换为纽约时区:")
print(ts_ny)
```

### 9.6.2 时区转换

```python
# 创建带时区的日期范围
dates_utc = pd.date_range('2024-01-01', periods=5, freq='D', tz='UTC')
ts = pd.Series(range(5), index=dates_utc)
print("UTC时区时间序列:")
print(ts)

# 转换为多个时区
ts_tokyo = ts.tz_convert('Asia/Tokyo')
ts_london = ts.tz_convert('Europe/London')
ts_ny = ts.tz_convert('America/New_York')

df = pd.DataFrame({
    'UTC': ts,
    'Tokyo': ts_tokyo,
    'London': ts_london,
    'New York': ts_ny
})
print("\n不同时区的时间:")
print(df)
```

## 9.7 时间序列可视化

```python
import matplotlib.pyplot as plt

# 创建时间序列数据
dates = pd.date_range('2024-01-01', periods=365, freq='D')
trend = np.linspace(0, 10, 365)
seasonal = 3 * np.sin(2 * np.pi * np.arange(365) / 365.25)
noise = np.random.randn(365) * 0.5
ts = pd.Series(trend + seasonal + noise, index=dates)

# 绘制原始数据
plt.figure(figsize=(12, 6))
ts.plot()
plt.title('Time Series Data')
plt.xlabel('Date')
plt.ylabel('Value')
plt.grid(True)
plt.tight_layout()
# plt.savefig('time_series.png')
print("时间序列图已创建")

# 绘制移动平均
plt.figure(figsize=(12, 6))
ts.plot(label='Original', alpha=0.5)
ts.rolling(window=30).mean().plot(label='30-day MA', linewidth=2)
ts.rolling(window=90).mean().plot(label='90-day MA', linewidth=2)
plt.title('Time Series with Moving Averages')
plt.xlabel('Date')
plt.ylabel('Value')
plt.legend()
plt.grid(True)
plt.tight_layout()
# plt.savefig('time_series_ma.png')
print("移动平均图已创建")
```

## 9.8 综合案例：股票数据分析

```python
# 创建模拟的股票数据
np.random.seed(42)
dates = pd.date_range('2024-01-01', periods=252, freq='B')  # 一年的交易日
prices = 100 + np.random.randn(252).cumsum()
volume = np.random.randint(1000000, 5000000, 252)

stock = pd.DataFrame({
    'Close': prices,
    'Volume': volume
}, index=dates)

# 添加开盘、最高、最低价
stock['Open'] = stock['Close'] + np.random.randn(252) * 0.5
stock['High'] = stock[['Open', 'Close']].max(axis=1) + np.random.rand(252) * 2
stock['Low'] = stock[['Open', 'Close']].min(axis=1) - np.random.rand(252) * 2

print("股票数据（前10天）:")
print(stock.head(10))

# 1. 计算日收益率
stock['Returns'] = stock['Close'].pct_change()
print("\n日收益率统计:")
print(stock['Returns'].describe())

# 2. 计算移动平均
stock['MA_5'] = stock['Close'].rolling(window=5).mean()
stock['MA_20'] = stock['Close'].rolling(window=20).mean()
stock['MA_60'] = stock['Close'].rolling(window=60).mean()
print("\n添加移动平均后（前10天）:")
print(stock[['Close', 'MA_5', 'MA_20', 'MA_60']].head(10))

# 3. 计算波动率（20日滚动标准差）
stock['Volatility'] = stock['Returns'].rolling(window=20).std()
print("\n波动率统计:")
print(stock['Volatility'].describe())

# 4. 计算RSI（相对强弱指标）
def calculate_rsi(prices, period=14):
    delta = prices.diff()
    gain = (delta.where(delta > 0, 0)).rolling(window=period).mean()
    loss = (-delta.where(delta < 0, 0)).rolling(window=period).mean()
    rs = gain / loss
    rsi = 100 - (100 / (1 + rs))
    return rsi

stock['RSI'] = calculate_rsi(stock['Close'])
print("\nRSI统计:")
print(stock['RSI'].describe())

# 5. 按月统计
monthly = stock['Close'].resample('M').agg(['first', 'last', 'min', 'max'])
monthly['Return'] = (monthly['last'] - monthly['first']) / monthly['first']
print("\n月度统计:")
print(monthly)

# 6. 找出最大涨跌幅
max_gain_idx = stock['Returns'].idxmax()
max_loss_idx = stock['Returns'].idxmin()
print(f"\n最大涨幅日期: {max_gain_idx}, 涨幅: {stock.loc[max_gain_idx, 'Returns']:.2%}")
print(f"最大跌幅日期: {max_loss_idx}, 跌幅: {stock.loc[max_loss_idx, 'Returns']:.2%}")

# 7. 计算累计收益
stock['Cumulative_Returns'] = (1 + stock['Returns']).cumprod() - 1
print(f"\n期间累计收益: {stock['Cumulative_Returns'].iloc[-1]:.2%}")

# 8. 波动率分析
high_volatility = stock[stock['Volatility'] > stock['Volatility'].mean()]
print(f"\n高波动交易日数: {len(high_volatility)}")

print("\n股票数据分析完成！")
```

## 9.9 时间序列分解

```python
# 创建带有趋势和季节性的时间序列
dates = pd.date_range('2024-01-01', periods=365, freq='D')
trend = np.linspace(100, 150, 365)
seasonal = 10 * np.sin(2 * np.pi * np.arange(365) / 365.25 * 4)
noise = np.random.randn(365) * 2
ts = pd.Series(trend + seasonal + noise, index=dates)

print("原始时间序列统计:")
print(ts.describe())

# 简单的趋势提取（移动平均）
trend_extracted = ts.rolling(window=30, center=True).mean()
detrended = ts - trend_extracted
print("\n去趋势后的数据统计:")
print(detrended.describe())

# 计算季节性（简单方法）
seasonal_extracted = detrended.rolling(window=7, center=True).mean()
residual = detrended - seasonal_extracted
print("\n残差统计:")
print(residual.describe())
```

## 9.10 练习题

1. **基础练习**：创建一个时间序列，练习不同的日期索引和切片方法。

2. **移动平均**：创建股票价格数据，计算不同窗口的移动平均并比较。

3. **重采样**：创建小时级别的数据，重采样为日、周、月级别。

4. **时区转换**：创建不同时区的时间序列并进行转换。

5. **综合案例**：分析一个完整的时间序列数据集，包括趋势、季节性、异常值检测等。

## 9.11 小结

本章介绍了Pandas中的时间序列处理：

- **日期时间基础**：Timestamp、Period、Timedelta
- **日期时间索引**：date_range、时间序列创建
- **时间序列选择**：字符串索引、切片、truncate
- **时间序列操作**：shift、diff、pct_change
- **窗口函数**：rolling、expanding、ewm
- **重采样**：降采样、升采样、频率转换
- **时区处理**：tz_localize、tz_convert
- **实战应用**：股票数据分析、时间序列分解

掌握这些技术可以有效处理各种时间序列数据。

## 下一章

在下一章中，我们将学习**数据可视化**，包括使用Pandas内置的绘图功能和结合Matplotlib进行可视化。
